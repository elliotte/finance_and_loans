<% cp = $cp %>
<% pp = $pp %>
<!-- CALC PLACEHOLDERS -->
<% cy_gp_rev = [0] %>
<% py_gp_rev = [0] %>
<% cy_gp_cos = [0] %>
<% py_gp_cos = [0] %>
<% cy_op_rev = [0]  %>
<% py_op_rev = [0]  %>
<% cy_op_cos = [0]  %>
<% py_op_cos = [0]  %>
<% cy_iat = [0] %>
<% py_iat = [0] %>

<!-- RATIO AND STATS DISPLAY -->

                    <!-- GROSS PROFIT REVENUE TAGS -->
                    <% @tags[:gp_sales].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                     
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                      <span class="js-fs-line" data-tag="gp-rev" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                      <!-- END OF UNLESS -->
                    <% end %>
                    
                    <!-- GROSS PROFIT COS TAGS -->
                    <% @tags[:gp_cos].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                      
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                      <span class="js-fs-line" data-tag="gp-cos" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                      <!-- END OF UNLESS -->
                    <% end %>
                    
                    <!-- GROSS PROFIT ROW -->
                    <% cy_rev = cy_gp_rev.inject(:+)  %>
                    <% py_rev = py_gp_rev.inject(:+)  %>
                    <% cy_cos = cy_gp_cos.inject(:+) %>
                    <% py_cos = py_gp_cos.inject(:+) %>
                    <% gp_cy = cy_rev - cy_cos %>
                    <% gp_py = py_rev - py_cos %>
                    <%gp_margin_cy = margin_percentage(gp_cy, cy_rev) %>
                    <%gp_margin_py = margin_percentage(gp_py, py_rev) %>
                    <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                    <span id="js-gp-margin-data" data-cy="<%= gp_margin_cy %>" data-py="<%= gp_margin_py %>" ></span>
                    <!-- OP MARGIN REV ROWS -->
                    <% @tags[:op_sales].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                     <span class="js-fs-line" data-tag="op-rev" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                    <% end %>

                    <!-- OP MARGIN COS ROWS -->
                    <% @tags[:op_dis].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                      
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                      <span class="js-fs-line" data-tag="op-cos" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                    <% end %>
                    <!-- !!!!!!!! SUMMARY ITERATION !!!!!!!!! -->
                    <!-- SUM ALL ADMIN EXPENSES -->
                    <% $cy_admin_expenses_amt = 0 %>
                    <% $py_admin_expenses_amt = 0 %>
                    <% @tags[:op_admin].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                        <% $cy_admin_expenses_amt += cy_amt %>
                        <% $py_admin_expenses_amt += py_amt %>
                        <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                        <span class="js-fs-line" data-tag="op-cos" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                      <!-- END OF UNLESS -->
                    <% end %>
                    <!-- DISPLAY SUMMARIES ADMIN EXPENSES -->
                    
                    <!-- OP PROFIT DISPLAY ROW -->
                    <% cy_rev_op = cy_op_rev.inject(:+) %>
                    <% py_rev_op = py_op_rev.inject(:+) %>
                    <% cy_cos = cy_op_cos.inject(:+) %>
                    <% py_cos = py_op_cos.inject(:+) %>
                    <% op_cy = gp_cy + cy_rev_op - cy_cos %>
                    <% op_py = gp_py + py_rev_op - py_cos %>
                    <%op_margin_cy = margin_percentage(op_cy, cy_rev) %>
                    <% op_margin_py = margin_percentage(op_py, py_rev) %>
                    <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                    <span id="js-op-margin-data" data-cy="<%= op_margin_cy %>" data-py="<%= op_margin_py %>" ></span>

                    <!-- FINANCING INCOME ROWS -->
                    <% @tags[:pbiat_sales].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                      
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                      <span class="js-fs-line" data-tag="op-cos" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                    <% end %>
                    <!-- FINANCING cost ROWS -->
                    <% @tags[:pbiat_cos].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                      
                        <% cy_iat << cy_amt %>
                        <% py_iat << py_amt %>
                        <% mvmt = cy_amt - py_amt %>
                        
                      <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                      <span class="js-fs-line" data-tag="op-cos" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                    <% end %>
                    
                    <% $cy_tax_expenses_amt = 0 %>
                    <% $py_tax_expenses_amt = 0 %>
                    <!-- SUM ALL TAX EXPENSES -->
                    <% @tags[:tax_cos].each do | master_tag | %>
                      <% cy = find_data(master_tag, :cy)  %>
                      <% py = find_data(master_tag, :py)  %>
                      <% cy_amt = yield_amount { cy }.to_i %>
                      <% py_amt = yield_amount { py }.to_i %>
                      <% unless (cy_amt + py_amt == 0.00) %>
                        <% $cy_tax_expenses_amt += cy_amt %>
                        <% $py_tax_expenses_amt += py_amt %>
                        <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                        <span class="js-fs-line" data-tag="tax" data-reporting-line="<%= master_tag %>" data-cy="<%= cy_amt %>" data-py="<%= py_amt %>"></span>
                      <% end %>
                      <!-- END OF UNLESS -->
                    <% end %>
                    <!-- DISPLAY SUMMARIES TAX EXPENSES -->
                    
                    <!-- PAT CALCULATION and PROFIT DISPLAY ROW -->
                    <% cy_tax_and_int = cy_iat.inject(:+) %>
                    <% py_tax_and_int = py_iat.inject(:+) %>
                    <% $cy_pat = op_cy - cy_tax_and_int %>
                    <% $py_pat = op_py - py_tax_and_int %>
                    
                    <!-- HIDDEN JS LINE GP_COS for FSEXPORT -->
                    <span id="js-margin-data" data-cy="<%= op_margin_cy %>" data-py="<%= op_margin_py %>" ></span>                    
